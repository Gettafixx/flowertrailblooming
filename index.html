<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Motion Bloom Cam</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#10182dcc;
      --accent:#7dd3fc;
      --text:#e6eefc;
      --muted:#9fb2d8;
      --btn:#1f2a48;
      --btnHover:#2a3963;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text); background:
        radial-gradient(1200px 600px at 85% 20%, #1a1f3e, transparent 60%),
        radial-gradient(800px 500px at 20% 70%, #10223a, transparent 60%),
        var(--bg);
      overflow:hidden; /* keep things tidy when fullscreen */
    }
    .app{display:flex; flex-direction:column; gap:14px; height:100%; padding:16px;}

    .stage{position:relative; flex:1 1 auto; min-height:320px; border-radius:18px; overflow:hidden; background:#050813; box-shadow:var(--shadow);}
    .stage::after{ /* subtle vignette */
      content:""; position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(60% 80% at 50% 50%, transparent 40%, rgba(0,0,0,.35));
    }

    #display{position:absolute; inset:0; width:100%; height:100%; display:block; background: var(--userBg, #000);}
    #blooms{position:absolute; inset:0; pointer-events:none;}

    .status{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:linear-gradient(180deg, #14203b, #0e162e); border:1px solid #243154; color:var(--text);
      padding:14px 16px; border-radius:14px; box-shadow:var(--shadow); font-size:14px; display:none;}
    .status.show{display:flex; align-items:center; gap:10px}
    .status .dot{width:10px;height:10px;border-radius:50%;background:#7dd3fc; box-shadow:0 0 18px #7dd3fc99}

    .ui{position:relative; z-index:3; display:flex; flex-direction:column; gap:10px;}
    .controls{display:grid; grid-template-columns: repeat( auto-fit, minmax(200px, 1fr) ); gap:10px; background:var(--panel);
      backdrop-filter: blur(10px); border:1px solid #1f2b4d; padding:12px; border-radius:14px; box-shadow:var(--shadow);}
    .group{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:8px;}
    .group label{font-size:12px; color:var(--muted)}
    .group input[type="range"]{width:100%; accent-color:var(--accent)}
    .group output{font-variant-numeric: tabular-nums; font-size:12px; color:#bcd0f8; padding:2px 8px; background:#0b1530; border:1px solid #1f2b4d; border-radius:10px;}

    .buttons{display:flex; gap:8px; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid #243154; background:linear-gradient(180deg, var(--btn), #162144);
      color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600; letter-spacing:.2px; box-shadow:var(--shadow);
      transition:.2s transform, .2s background;
    }
    .btn:hover{background:var(--btnHover); transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}

    .show-ui{position:fixed; right:14px; bottom:14px; z-index:50}

    /* Flowers */
    .flower{position:absolute; transform: translate(-50%,-50%) rotate(var(--rot,0deg));
      filter: drop-shadow(0 4px 12px rgba(0,0,0,.45)); opacity:0; will-change: transform, opacity; pointer-events:none;
      animation: bloom var(--life,3s) ease-out forwards;}

    @keyframes bloom{
      0%   { transform: translate(-50%,-50%) rotate(var(--rot,0deg)) scale(.2); opacity:0}
      15%  { transform: translate(-50%,-50%) rotate(var(--rot,0deg)) scale(1.2); opacity:1}
      30%  { transform: translate(-50%,-50%) rotate(var(--rot,0deg)) scale(1)}
      85%  { opacity:1 }
      100% { opacity:0 }
    }

    /* Hide UI state */
    .ui.hidden{display:none}

    /* Small helper text */
    .hint{font-size:12px; color:#9fb2d8; opacity:.8}
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="stage" id="stage" aria-label="Camera stage">
      <canvas id="display"></canvas>
      <canvas id="buffer" width="0" height="0" style="display:none"></canvas>
      <canvas id="buffer" width="0" height="0" style="display:none"></canvas>
      <div id="blooms" aria-hidden="true"></div>
      <div id="status" class="status"><span class="dot"></span> <span id="statusText">Requesting camera…</span></div>
    </div>

    <div id="ui" class="ui" role="region" aria-label="Controls">
      <div class="controls">
        <div class="group">
          <label for="sensitivity">Sensitivity</label>
          <input id="sensitivity" type="range" min="10" max="300" value="70" step="1" />
          <output id="sensitivityOut">70</output>
        </div>
        <div class="group">
          <label for="lifetime">Flower lifetime (s)</label>
          <input id="lifetime" type="range" min="0.5" max="10" value="3" step="0.5" />
          <output id="lifetimeOut">3.0s</output>
        </div>
        <div class="group">
          <label for="maxPerFrame">Max flowers / frame</label>
          <input id="maxPerFrame" type="range" min="0" max="30" value="7" step="1" />
          <output id="maxPerFrameOut">7</output>
        </div>
        <div class="group">
          <label for="step">Motion sampling step (px)</label>
          <input id="step" type="range" min="4" max="40" value="12" step="1" />
          <output id="stepOut">12px</output>
        </div>
        <div class="group">
          <label for="density">Bloom density</label>
          <input id="density" type="range" min="0" max="100" value="25" step="1" />
          <output id="densityOut">25%</output>
        </div>
        <div class="group">
          <label for="size">Flower size (px)</label>
          <input id="size" type="range" min="24" max="180" value="90" step="2" />
          <output id="sizeOut">90px</output>
        </div>
        <div class="group">
          <label for="radius">Bloom radius (px)</label>
          <input id="radius" type="range" min="0" max="160" value="60" step="2" />
          <output id="radiusOut">60px</output>
        </div>
        <div class="group">
          <label for="fps">Process FPS</label>
          <input id="fps" type="range" min="8" max="60" value="24" step="1" />
          <output id="fpsOut">24</output>
        </div>
        <div class="group">
          <label for="blur">Smoothing (blur px)</label>
          <input id="blur" type="range" min="0" max="3" value="1" step="1" />
          <output id="blurOut">1px</output>
        </div>
        <div class="group">
          <label for="bgcolor">Background color</label>
          <input id="bgcolor" type="color" value="#000000" />
          <output id="bgcolorOut">#000000</output>
        </div>
        <div class="group">
          <label for="bgcolor">Background color</label>
          <input id="bgcolor" type="color" value="#000000" />
          <output id="bgcolorOut">#000000</output>
        </div>
      </div>
      <div class="buttons">
        <button id="toggleMirror" class="btn" aria-pressed="true">Mirror: On<\/button>
        <button id="toggleCam" class="btn" aria-pressed="true">Camera: On<\/button>
        <button id="togglePause" class="btn" aria-pressed="false">Pause</button>
        <button id="clearBtn" class="btn">Clear</button>
        <button id="hideUiBtn" class="btn">Hide UI</button>
        <button id="fsBtn" class="btn" title="Toggle Fullscreen">Fullscreen ⛶</button>
      </div>
      <div class="hint">Tip: move your hand near the camera. Flowers spawn around motion and fade after the chosen time.</div>
    </div>

    <button id="showUiBtn" class="btn show-ui" hidden>Show UI</button>
  </div>

  <!-- Hidden video just for capture -->
  <video id="video" autoplay playsinline muted style="display:none"></video>

  <script>
  (function(){
    const video = document.getElementById('video');
    const stage = document.getElementById('stage');
    const canvas = document.getElementById('display');
    const ctx = canvas.getContext('2d', { willReadFrequently:true });
    const buffer = document.getElementById('buffer');
    const bctx = buffer.getContext('2d', { willReadFrequently:true });
    const blooms = document.getElementById('blooms');
    const statusBox = document.getElementById('status');
    const statusText = document.getElementById('statusText');

    // Controls
    const controls = {
      sensitivity: bindSlider('sensitivity','sensitivityOut', v=>v),
      lifetime: bindSlider('lifetime','lifetimeOut', v=>Number(v).toFixed(1)+"s"),
      maxPerFrame: bindSlider('maxPerFrame','maxPerFrameOut', v=>v),
      step: bindSlider('step','stepOut', v=>v+"px"),
      density: bindSlider('density','densityOut', v=>v+"%"),
      size: bindSlider('size','sizeOut', v=>v+"px"),
      radius: bindSlider('radius','radiusOut', v=>v+"px"),
      fps: bindSlider('fps','fpsOut', v=>v),
      blur: bindSlider('blur','blurOut', v=>v+"px"),
      bgcolor: bindColor('bgcolor','bgcolorOut'),
      bgcolor: bindColor('bgcolor','bgcolorOut'),
      mirrorBtn: document.getElementById('toggleMirror'),
      camBtn: document.getElementById('toggleCam'),
      camBtn: document.getElementById('toggleCam'),
      pauseBtn: document.getElementById('togglePause'),
      clearBtn: document.getElementById('clearBtn'),
      hideUiBtn: document.getElementById('hideUiBtn'),
      fsBtn: document.getElementById('fsBtn'),
      ui: document.getElementById('ui'),
      showUiBtn: document.getElementById('showUiBtn'),
    };

    // State
    let mirror = true;
    let running = true;
    let camOn = true;
    let stream = null;
    let camOn = true;
    let stream = null;
    let lastFrame = null; // ImageData
    let lastTick = 0;
    let aspect = 16/9;

    // Restore previous settings if any
    restoreSettings();

    // Wire buttons
    controls.mirrorBtn.addEventListener('click', ()=>{
      mirror = !mirror;
      controls.mirrorBtn.textContent = `Mirror: ${mirror? 'On':'Off'}`;
      controls.mirrorBtn.setAttribute('aria-pressed', String(mirror));
    });
    controls.pauseBtn.addEventListener('click', ()=>{
      running = !running; controls.pauseBtn.textContent = running? 'Pause':'Resume';
      controls.pauseBtn.setAttribute('aria-pressed', String(!running));
    });
    controls.camBtn.addEventListener('click', async ()=>{
      if(camOn){
        stopCamera();
        controls.camBtn.textContent = 'Camera: Off';
        controls.camBtn.setAttribute('aria-pressed','false');
      } else {
        await startCamera();
        controls.camBtn.textContent = 'Camera: On';
        controls.camBtn.setAttribute('aria-pressed','true');
      }
    });
    controls.clearBtn.addEventListener('click', clearBlooms);
    controls.hideUiBtn.addEventListener('click', ()=>{
      controls.ui.classList.add('hidden');
      controls.showUiBtn.hidden = false;
    });
    controls.showUiBtn.addEventListener('click', ()=>{
      controls.ui.classList.remove('hidden');
      controls.showUiBtn.hidden = true;
    });
    controls.fsBtn.addEventListener('click', async ()=>{
      try{
        if(!document.fullscreenElement){ await stage.requestFullscreen(); }
        else { await document.exitFullscreen(); }
      }catch(e){ console.warn(e); }
    });

    // Resize canvas to stage
    const resizeObserver = new ResizeObserver(()=> fitCanvas());
    resizeObserver.observe(stage);

    function fitCanvas(){
      const rect = stage.getBoundingClientRect();
      const w = Math.floor(rect.width), h = Math.floor(rect.height);
      if(canvas.width !== w || canvas.height !== h){
        canvas.width = w; canvas.height = h;
        buffer.width = w; buffer.height = h;
      }
    }
    }
    }

    // Init camera
    async function startCamera(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        showStatus('getUserMedia not supported in this browser');
        camOn = false;
        return;
      }
      showStatus('Requesting camera…');
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        camOn = true;
        aspect = video.videoWidth && video.videoHeight ? (video.videoWidth / video.videoHeight) : 16/9;
        stage.style.aspectRatio = aspect.toFixed(4);
        hideStatus();
        fitCanvas();
        requestAnimationFrame(tick);
      }catch(err){
        console.error(err);
        camOn = false;
        showStatus('Camera error: ' + (err.message || err.name || err));
      }
    }
    function stopCamera(){
      try{
        if(stream){ stream.getTracks().forEach(t=>t.stop()); }
      }catch(e){}
      video.srcObject = null;
      camOn = false;
      showStatus('Camera off');
    }
    startCamera();
  </script>
</body>
</html>
